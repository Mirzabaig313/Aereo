name: Build & Release

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: Aereo

jobs:
  # ─── Build & Test ────────────────────────────────────────────
  build:
    name: Build & Test
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: |
          LATEST_XCODE=$(ls -d /Applications/Xcode*.app | sort -V | tail -n 1)
          sudo xcode-select -s "$LATEST_XCODE/Contents/Developer"
          xcodebuild -version
          swift --version

      - name: Resolve Dependencies
        run: swift package resolve

      - name: Build (Debug)
        run: swift build -c debug --build-path .build-ci

      - name: Build (Release)
        run: swift build -c release --build-path .build-ci

      - name: Run Tests
        run: swift test --parallel --build-path .build-ci
        continue-on-error: true  # XCTest requires full Xcode

      - name: Upload Release Binary
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: Aereo-unsigned
          path: .build-ci/release/Aereo

  # ─── GitHub Release ─────────────────────────────────────────
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download Unsigned Binary
        uses: actions/download-artifact@v4
        with:
          name: Aereo-unsigned
          path: ./dist

      - name: Package Unsigned Binary
        run: |
          chmod +x ./dist/Aereo
          VERSION="${GITHUB_REF_NAME#v}"
          if [ -z "$VERSION" ]; then VERSION="0.0.0"; fi

          mkdir -p ./dist/Aereo.app/Contents/MacOS
          mv ./dist/Aereo ./dist/Aereo.app/Contents/MacOS/Aereo

          cat > ./dist/Aereo.app/Contents/Info.plist <<PLIST
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleDevelopmentRegion</key>
            <string>en</string>
            <key>CFBundleExecutable</key>
            <string>Aereo</string>
            <key>CFBundleIdentifier</key>
            <string>com.aereo.app</string>
            <key>CFBundleInfoDictionaryVersion</key>
            <string>6.0</string>
            <key>CFBundleName</key>
            <string>Aereo</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>${VERSION}</string>
            <key>CFBundleVersion</key>
            <string>${VERSION}</string>
            <key>LSMinimumSystemVersion</key>
            <string>15.0</string>
            <key>LSUIElement</key>
            <true/>
          </dict>
          </plist>
          PLIST

          cd ./dist
          zip -r -9 Aereo-macOS-unsigned.zip Aereo.app

      - name: Generate Changelog
        id: changelog
        run: |
          # Get commits since last tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            CHANGES=$(git log "$PREV_TAG"..HEAD --pretty=format:"- %s" --no-merges)
          else
            CHANGES=$(git log --pretty=format:"- %s" --no-merges -20)
          fi
          echo "changes<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./dist/Aereo-macOS-unsigned.zip
          body: |
            ## What's Changed
            ${{ steps.changelog.outputs.changes }}

            ## Installation
            1. Download `Aereo-macOS-unsigned.zip`
            2. Unzip and drag `Aereo.app` to Applications
            3. On first launch, right-click `Aereo.app` and choose **Open**
            4. Confirm **Open** in the security prompt
            
            ## Requirements
            - macOS 15.0 (Sequoia) or later
            - Lock screen features require macOS 26 (Tahoe)

            ## Note
            This build is unsigned and not notarized.
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
