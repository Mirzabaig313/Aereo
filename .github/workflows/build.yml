name: Build & Release

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: Aereo

jobs:
  # ─── Build & Test ────────────────────────────────────────────
  build:
    name: Build & Test
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: |
          LATEST_XCODE=$(ls -d /Applications/Xcode*.app | sort -V | tail -n 1)
          sudo xcode-select -s "$LATEST_XCODE/Contents/Developer"
          xcodebuild -version
          swift --version

      - name: Resolve Dependencies
        run: swift package resolve

      - name: Build (Debug)
        run: swift build -c debug --build-path .build-ci

      - name: Build (Release)
        run: swift build -c release --build-path .build-ci

      - name: Run Tests
        run: swift test --parallel --build-path .build-ci
        continue-on-error: true  # XCTest requires full Xcode

      - name: Upload Release Binary
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: Aereo-unsigned
          path: .build-ci/release/Aereo

  # ─── GitHub Release ─────────────────────────────────────────
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download Unsigned Binary
        uses: actions/download-artifact@v4
        with:
          name: Aereo-unsigned
          path: ./dist

      - name: Package Unsigned Binary
        run: |
          chmod +x ./dist/Aereo
          cd ./dist
          zip -9 Aereo-macOS-unsigned.zip Aereo

      - name: Generate Changelog
        id: changelog
        run: |
          # Get commits since last tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            CHANGES=$(git log "$PREV_TAG"..HEAD --pretty=format:"- %s" --no-merges)
          else
            CHANGES=$(git log --pretty=format:"- %s" --no-merges -20)
          fi
          echo "changes<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./dist/Aereo-macOS-unsigned.zip
          body: |
            ## What's Changed
            ${{ steps.changelog.outputs.changes }}

            ## Installation
            1. Download `Aereo-macOS-unsigned.zip`
            2. Unzip and move `Aereo` to your preferred location
            3. On first launch, right-click `Aereo` and choose **Open**
            4. Confirm **Open** in the security prompt
            
            ## Requirements
            - macOS 15.0 (Sequoia) or later
            - Lock screen features require macOS 26 (Tahoe)

            ## Note
            This build is unsigned and not notarized.
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
