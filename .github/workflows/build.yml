name: Build & Release

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  APP_NAME: Aereo

jobs:
  # ─── Build & Test ────────────────────────────────────────────
  build:
    name: Build & Test
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: |
          LATEST_XCODE=$(ls -d /Applications/Xcode*.app | sort -V | tail -n 1)
          sudo xcode-select -s "$LATEST_XCODE/Contents/Developer"
          xcodebuild -version
          swift --version

      - name: Resolve Dependencies
        run: swift package resolve

      - name: Build (Debug)
        run: swift build -c debug --build-path .build-ci

      - name: Build (Release)
        run: swift build -c release --build-path .build-ci

      - name: Run Tests
        run: swift test --parallel --build-path .build-ci
        continue-on-error: true  # XCTest requires full Xcode

      - name: Upload Release Binary
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/upload-artifact@v4
        with:
          name: Aereo-unsigned
          path: .build-ci/release/Aereo

  # ─── Code Sign & Notarize ───────────────────────────────────
  sign-and-notarize:
    name: Sign & Notarize
    needs: build
    runs-on: macos-15
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: |
          LATEST_XCODE=$(ls -d /Applications/Xcode*.app | sort -V | tail -n 1)
          sudo xcode-select -s "$LATEST_XCODE/Contents/Developer"
          xcodebuild -version
          swift --version

      - name: Download Unsigned Binary
        uses: actions/download-artifact@v4
        with:
          name: Aereo-unsigned
          path: ./dist

      - name: Import Signing Certificate
        env:
          CERTIFICATE_BASE64: ${{ secrets.DEVELOPER_ID_CERTIFICATE }}
          CERTIFICATE_PASSWORD: ${{ secrets.DEVELOPER_ID_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          CERT_PATH=$RUNNER_TEMP/certificate.p12
          export CERT_PATH
          python3 - <<'PY'
          import base64
          import os
          import sys

          raw = os.environ.get("CERTIFICATE_BASE64", "").strip()
          if not raw:
              print("DEVELOPER_ID_CERTIFICATE secret is empty", file=sys.stderr)
              sys.exit(1)

          variants = [
              raw,
              raw.replace("\\n", ""),
              raw.replace("\\r", "").replace("\\n", ""),
          ]

          out_path = os.environ["CERT_PATH"]
          last_error = None
          for value in variants:
              try:
                  decoded = base64.b64decode(value, validate=True)
                  if len(decoded) < 256:
                      raise ValueError("decoded data too small to be a valid .p12")
                  with open(out_path, "wb") as f:
                      f.write(decoded)
                  sys.exit(0)
              except Exception as e:
                  last_error = e

          print(f"Failed to decode DEVELOPER_ID_CERTIFICATE as base64: {last_error}", file=sys.stderr)
          sys.exit(1)
          PY

          # Validate PKCS#12 payload before importing into keychain
          openssl pkcs12 -in "$CERT_PATH" -passin pass:"$CERTIFICATE_PASSWORD" -nokeys -clcerts > /dev/null

          security import "$CERT_PATH" \
            -P "$CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 \
            -k "$KEYCHAIN_PATH"

          # Set keychain search list
          security list-keychain -d user -s "$KEYCHAIN_PATH"

      - name: Code Sign
        env:
          SIGNING_IDENTITY: ${{ secrets.SIGNING_IDENTITY }}
        run: |
          chmod +x ./dist/Aereo
          codesign --force --deep --options runtime \
            --sign "$SIGNING_IDENTITY" \
            --timestamp \
            ./dist/Aereo

          # Verify
          codesign --verify --verbose=2 ./dist/Aereo

      - name: Create DMG
        run: |
          mkdir -p ./dmg-contents
          cp ./dist/Aereo ./dmg-contents/
          cp README.md ./dmg-contents/

          hdiutil create -volname "Aereo" \
            -srcfolder ./dmg-contents \
            -ov -format UDZO \
            ./Aereo.dmg

      - name: Sign DMG
        env:
          SIGNING_IDENTITY: ${{ secrets.SIGNING_IDENTITY }}
        run: |
          codesign --force --sign "$SIGNING_IDENTITY" --timestamp ./Aereo.dmg

      - name: Notarize
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        run: |
          xcrun notarytool submit ./Aereo.dmg \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --wait

          # Staple the notarization ticket
          xcrun stapler staple ./Aereo.dmg

      - name: Upload Signed DMG
        uses: actions/upload-artifact@v4
        with:
          name: Aereo-signed
          path: ./Aereo.dmg

  # ─── GitHub Release ─────────────────────────────────────────
  release:
    name: Create Release
    needs: sign-and-notarize
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download Signed DMG
        uses: actions/download-artifact@v4
        with:
          name: Aereo-signed
          path: ./dist

      - name: Generate Changelog
        id: changelog
        run: |
          # Get commits since last tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            CHANGES=$(git log "$PREV_TAG"..HEAD --pretty=format:"- %s" --no-merges)
          else
            CHANGES=$(git log --pretty=format:"- %s" --no-merges -20)
          fi
          echo "changes<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ./dist/Aereo.dmg
          body: |
            ## What's Changed
            ${{ steps.changelog.outputs.changes }}

            ## Installation
            1. Download `Aereo.dmg`
            2. Open the DMG and drag Aereo to Applications
            3. Launch from Applications — appears in menu bar
            
            ## Requirements
            - macOS 15.0 (Sequoia) or later
            - Lock screen features require macOS 26 (Tahoe)
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
